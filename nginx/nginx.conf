worker_processes auto;
events { worker_connections 1024; }

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;
    sendfile      on;

    # --- UPSTREAMS ---
    upstream frontend { server frontend:5173; }
    upstream api_gateway { server api-gateway:3000; }
    
    # PHP-FPM Upstreams
    upstream auth_php { server cfc-auth-service:9000; }
    upstream formation_php { server cfc-formation-service:9000; }
    upstream registration_php { server cfc-registration-service:9000; }

    server {
        listen 80;
        root /var/www; # Base directory shared in docker-compose

        # 1. Frontend (Vite)
        location / {
            proxy_pass http://frontend;
            proxy_set_header Host $host;
            # Enable WebSockets for Vite HMR
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }

        # 2. API Gateway (NestJS)
        location /api {
            proxy_pass http://api_gateway;
            proxy_set_header Host $host;
        }

        # 3. Internal Laravel Routing (For the Gateway to call)
        # This handles the FastCGI pass for your services
        location ~ ^/internal/auth/(.*)$ {
            alias /var/www/auth/public;
            fastcgi_pass auth_php;
            include fastcgi_params;
            fastcgi_param SCRIPT_FILENAME /var/www/auth/public/index.php;
        }

        location ~ ^/internal/formation/(.*)$ {
            alias /var/www/formation/public;
            fastcgi_pass formation_php;
            include fastcgi_params;
            fastcgi_param SCRIPT_FILENAME /var/www/formation/public/index.php;
        }
    }
}